<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Alpha Cloud Pro</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        :root {
            --bg: #F2F2F7;
            --card: #FFFFFF;
            --blue: #007AFF;
            --green: #34C759;
            --red: #FF3B30;
            --gray: #8E8E93;
            --separator: #C6C6C8;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif;
            background-color: var(--bg);
            margin: 0; padding: 0;
            color: #000;
            -webkit-tap-highlight-color: transparent;
            overflow-x: hidden;
        }

        /* Анимация выезда модалок (Sheet) */
        .modal-view {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: var(--bg);
            z-index: 100;
            transform: translateY(100%);
            transition: transform 0.4s cubic-bezier(0.165, 0.84, 0.44, 1);
            display: flex; flex-direction: column;
        }
        .modal-view.active { transform: translateY(0); }

        /* Header */
        header {
            padding: 14px 20px;
            background: rgba(242, 242, 247, 0.95);
            backdrop-filter: blur(15px);
            position: sticky; top: 0; z-index: 50;
            border-bottom: 0.5px solid rgba(0,0,0,0.1);
            display: flex; justify-content: space-between; align-items: center;
            height: 44px;
        }
        h1 { font-size: 28px; font-weight: 800; margin: 0; }
        h2 { font-size: 17px; font-weight: 600; margin: 0; }

        /* Date Picker */
        .date-btn-wrapper { position: relative; }
        .date-btn {
            background: rgba(118, 118, 128, 0.12);
            color: var(--blue); font-weight: 500;
            padding: 6px 12px; border-radius: 8px; font-size: 15px; border: none;
        }
        .date-input-hidden {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            opacity: 0; cursor: pointer;
        }

        /* Grid */
        .grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; padding: 20px; }
        .table-card {
            background: var(--card); border-radius: 16px; height: 90px;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            border: none; box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            position: relative; transition: all 0.1s;
        }
        .table-card:active { transform: scale(0.95); background: #E5E5EA; }
        .table-card.done { border: 2px solid var(--green); background: #F0FFF4; }
        .t-num { font-size: 26px; font-weight: 700; color: var(--blue); }
        .done .t-num { color: var(--green); }
        .t-lbl { font-size: 11px; color: var(--gray); margin-top: 2px; }

        /* Lists */
        .list-wrap { padding: 20px; flex: 1; overflow-y: auto; padding-bottom: 120px; }
        .ios-list { background: var(--card); border-radius: 12px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .guest-row {
            display: flex; justify-content: space-between; align-items: center;
            padding: 14px 16px; border-bottom: 0.5px solid var(--separator);
        }
        .guest-row:last-child { border-bottom: none; }
        .g-name { font-size: 17px; font-weight: 400; }

        /* Toggle */
        .switch { position: relative; display: inline-block; width: 51px; height: 31px; flex-shrink: 0;}
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
            background-color: #E9E9EA; transition: .3s; border-radius: 34px;
        }
        .slider:before {
            position: absolute; content: ""; height: 27px; width: 27px; left: 2px; bottom: 2px;
            background-color: white; transition: .3s; border-radius: 50%; box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        input:checked + .slider { background-color: var(--green); }
        input:checked + .slider:before { transform: translateX(20px); }

        /* Bottom Bar */
        .fab-bar {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: rgba(255,255,255,0.9); backdrop-filter: blur(20px);
            padding: 12px 20px 35px; border-top: 0.5px solid rgba(0,0,0,0.1);
            display: flex; gap: 12px; z-index: 101;
        }
        .btn { flex: 1; padding: 14px; border-radius: 12px; border: none; font-size: 17px; font-weight: 600; cursor: pointer; }
        .btn-main { background: var(--blue); color: white; }
        .btn-sec { background: #E5E5EA; color: var(--blue); }
        .text-btn { background: none; border: none; color: var(--blue); font-size: 17px; cursor: pointer; }
        
        /* Stats Styles */
        .stat-header { cursor: pointer; }
        .stats-detail { display: none; background: #F8F8F8; padding: 12px 16px; font-size: 14px; border-bottom: 0.5px solid var(--separator); }
        .stats-detail.open { display: block; }
        .count-badge { background: #E5E5EA; color: #000; padding: 4px 10px; border-radius: 8px; font-weight: 700; }

        .loader { text-align: center; padding: 20px; color: var(--gray); }
    </style>
</head>
<body>

    <div class="view-home">
        <header>
            <h1>Alpha</h1>
            <div class="date-btn-wrapper">
                <button class="date-btn" id="dateBtnLabel">Сегодня</button>
                <input type="date" id="datePicker" class="date-input-hidden" onchange="changeDate(this.value)">
            </div>
        </header>

        <div class="grid" id="tablesGrid"></div>

        <div style="padding: 0 20px;">
            <button onclick="openStats()" class="btn btn-sec" style="width: 100%;">История и Статистика</button>
        </div>
    </div>

    <div id="modal-table" class="modal-view">
        <header>
            <button onclick="closeModal('modal-table')" class="text-btn">Назад</button>
            <h2 id="tableTitle">Стол</h2>
            <button onclick="toggleEditMode()" class="text-btn" id="editBtn">Изм.</button>
        </header>

        <div class="list-wrap">
            <div class="ios-list" id="guestListContainer"></div>
            <button class="text-btn" style="padding: 16px; width:100%; text-align:left;" onclick="addNewGuest()">+ Добавить гостя</button>
        </div>

        <div class="fab-bar">
            <button class="btn btn-main" onclick="saveAttendance()" id="saveBtn">Сохранить</button>
        </div>
    </div>

    <div id="modal-stats" class="modal-view">
        <header>
            <button onclick="closeModal('modal-stats')" class="text-btn">Закрыть</button>
            <h2>Статистика</h2>
            <div style="width:50px"></div>
        </header>
        <div class="list-wrap" id="statsContent"></div>
    </div>

    <script>
        // --- CONFIG ---
        const SUPABASE_URL = 'ТВОЙ_НОВЫЙ_URL';
        const SUPABASE_KEY = 'ТВОЙ_НОВЫЙ_KEY';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let currentTable = null;
        let activeDate = new Date().toISOString().split('T')[0];
        let isEditMode = false;

        // --- INIT ---
        function init() {
            updateDateLabel();
            loadGridStatuses();
        }

        function updateDateLabel() {
            const label = document.getElementById('dateBtnLabel');
            const today = new Date().toISOString().split('T')[0];
            const parts = activeDate.split('-');
            label.innerText = (activeDate === today) ? "Сегодня" : `${parts[2]}.${parts[1]}`;
            label.style.color = (activeDate === today) ? "var(--blue)" : "var(--red)";
        }

        function changeDate(val) {
            if(!val) return;
            activeDate = val;
            updateDateLabel();
            loadGridStatuses();
        }

        // --- HOME SCREEN ---
        async function loadGridStatuses() {
            const grid = document.getElementById('tablesGrid');
            grid.innerHTML = '<div class="loader">...</div>';
            
            const { data } = await supabase.from('attendance').select('table_number').eq('check_date', activeDate);
            const activeTables = new Set(data?.map(r => r.table_number));

            grid.innerHTML = '';
            for (let i = 1; i <= 12; i++) {
                const btn = document.createElement('button');
                btn.className = `table-card ${activeTables.has(i) ? 'done' : ''}`;
                btn.innerHTML = `<span class="t-num">${i}</span><span class="t-lbl">Стол</span>`;
                btn.onclick = () => openTable(i);
                grid.appendChild(btn);
            }
        }

        // --- MODAL NAVIGATION ---
        function openTable(num) {
            currentTable = num;
            isEditMode = false;
            document.getElementById('editBtn').innerText = "Изм.";
            document.getElementById('tableTitle').innerText = `Стол №${num}`;
            document.getElementById('modal-table').classList.add('active');
            renderGuestList();
        }

        function closeModal(id) {
            document.getElementById(id).classList.remove('active');
            if(id === 'modal-table') loadGridStatuses();
        }

        // --- GUEST LIST LOGIC ---
        async function renderGuestList() {
            const container = document.getElementById('guestListContainer');
            container.innerHTML = '<div class="loader">Загрузка...</div>';

            const { data: guests } = await supabase.from('guests').select('*').eq('table_number', currentTable).order('full_name');
            const { data: att } = await supabase.from('attendance').select('*').eq('check_date', activeDate).eq('table_number', currentTable);

            container.innerHTML = '';
            if (!guests || guests.length === 0) {
                container.innerHTML = '<div style="padding:20px; text-align:center; color:#999">Список пуст</div>';
                return;
            }

            guests.forEach(guest => {
                const record = att?.find(r => r.guest_id === guest.id);
                const isChecked = record ? record.is_present : true;

                const div = document.createElement('div');
                div.className = 'guest-row';

                if (isEditMode) {
                    div.innerHTML = `
                        <span class="g-name">${guest.full_name}</span>
                        <button class="text-btn" style="color:var(--red); font-size:14px;" onclick="deleteGuest(${guest.id})">Удалить</button>
                    `;
                } else {
                    div.innerHTML = `
                        <span class="g-name">${guest.full_name}</span>
                        <label class="switch">
                            <input type="checkbox" ${isChecked ? 'checked' : ''} data-id="${guest.id}">
                            <span class="slider"></span>
                        </label>
                    `;
                }
                container.appendChild(div);
            });
        }

        function toggleEditMode() {
            isEditMode = !isEditMode;
            document.getElementById('editBtn').innerText = isEditMode ? "Готово" : "Изм.";
            renderGuestList();
        }

        async function addNewGuest() {
            const name = prompt("ФИО гостя:");
            if (!name) return;
            await supabase.from('guests').insert([{ full_name: name, table_number: currentTable }]);
            renderGuestList();
        }

        async function deleteGuest(id) {
            if (!confirm("Удалить гостя?")) return;
            await supabase.from('guests').delete().eq('id', id);
            renderGuestList();
        }

        async function saveAttendance() {
            const btn = document.getElementById('saveBtn');
            btn.innerText = "Сохранение...";
            const inputs = document.querySelectorAll('#guestListContainer input[type="checkbox"]');
            const updates = Array.from(inputs).map(i => ({
                guest_id: i.dataset.id, check_date: activeDate, is_present: i.checked, table_number: currentTable
            }));

            await supabase.from('attendance').delete().eq('check_date', activeDate).eq('table_number', currentTable);
            await supabase.from('attendance').insert(updates);

            btn.innerText = "Готово!";
            setTimeout(() => { closeModal('modal-table'); btn.innerText = "Сохранить"; }, 600);
        }

        // --- STATS LOGIC ---
        async function openStats() {
            document.getElementById('modal-stats').classList.add('active');
            const container = document.getElementById('statsContent');
            container.innerHTML = '<div class="loader">Считаем...</div>';

            const { data } = await supabase.from('attendance').select('*').eq('is_present', true);
            const dates = [...new Set(data?.map(r => r.check_date))].sort().reverse();

            container.innerHTML = '<div class="ios-list">';
            dates.forEach((d, idx) => {
                const dayLog = data.filter(r => r.check_date === d);
                const byTable = {};
                dayLog.forEach(r => byTable[r.table_number] = (byTable[r.table_number] || 0) + 1);
                
                let details = '';
                for(let t=1; t<=12; t++) if(byTable[t]) details += `Стол ${t}: <b>${byTable[t]}</b><br>`;

                container.querySelector('.ios-list').innerHTML += `
                    <div class="guest-row stat-header" onclick="document.getElementById('st-${idx}').classList.toggle('open')">
                        <span>${d}</span><span class="count-badge">${dayLog.length}</span>
                    </div>
                    <div id="st-${idx}" class="stats-detail">${details}</div>`;
            });
            container.innerHTML += '</div>';
        }

        init();
    </script>
</body>
</html>