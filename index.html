<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Alpha Cloud</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        /* --- STYLES (Тот же красивый дизайн) --- */
        :root { --bg: #F2F2F7; --card: #FFFFFF; --blue: #007AFF; --green: #34C759; --red: #FF3B30; --gray: #8E8E93; --separator: #C6C6C8; }
        body { font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif; background-color: var(--bg); margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; overflow-x: hidden; }
        
        /* Views */
        .view-home { min-height: 100vh; padding-bottom: 40px; }
        .modal-view { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: var(--bg); z-index: 100; transform: translateY(100%); transition: transform 0.35s cubic-bezier(0.165, 0.84, 0.44, 1); display: flex; flex-direction: column; }
        .modal-view.active { transform: translateY(0); }

        /* Header */
        header { padding: 14px 20px; background: rgba(242, 242, 247, 0.95); backdrop-filter: blur(10px); position: sticky; top: 0; z-index: 50; border-bottom: 0.5px solid rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; height: 44px; }
        h1 { font-size: 28px; font-weight: 800; margin: 0; }
        h2 { font-size: 17px; font-weight: 600; margin: 0; }
        
        /* Components */
        .date-btn { background: rgba(118, 118, 128, 0.12); color: var(--blue); font-weight: 500; padding: 6px 12px; border-radius: 8px; border: none; font-size: 15px; }
        .date-input-hidden { position: absolute; opacity: 0; width: 100%; height: 100%; left:0; top:0; }
        .grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; padding: 20px; }
        .table-card { background: var(--card); border-radius: 16px; height: 90px; display: flex; flex-direction: column; justify-content: center; align-items: center; border: none; position: relative; transition: 0.1s; box-shadow: 0 2px 5px rgba(0,0,0,0.03); }
        .table-card:active { transform: scale(0.95); background: #E5E5EA; }
        .table-card.done { border: 2px solid var(--green); }
        .table-card.done .t-num { color: var(--green); }
        .t-num { font-size: 26px; font-weight: 700; color: var(--blue); }
        .t-lbl { font-size: 12px; color: var(--gray); margin-top: 2px; }
        
        /* Lists */
        .list-wrap { padding: 20px; flex: 1; overflow-y: auto; padding-bottom: 120px; }
        .ios-list { background: var(--card); border-radius: 12px; overflow: hidden; }
        .guest-row { display: flex; justify-content: space-between; align-items: center; padding: 14px 16px; border-bottom: 0.5px solid var(--separator); min-height: 24px; }
        .guest-row:last-child { border-bottom: none; }
        .g-name { font-size: 17px; font-weight: 400; }
        
        /* Switch */
        .switch { position: relative; width: 51px; height: 31px; flex-shrink: 0;}
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #E9E9EA; transition: .3s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 27px; width: 27px; left: 2px; bottom: 2px; background-color: white; transition: .3s; border-radius: 50%; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        input:checked + .slider { background-color: var(--green); }
        input:checked + .slider:before { transform: translateX(20px); }

        /* Controls */
        .fab-bar { position: fixed; bottom: 0; left: 0; right: 0; background: rgba(255,255,255,0.9); backdrop-filter: blur(20px); padding: 12px 20px 30px; border-top: 0.5px solid rgba(0,0,0,0.1); display: flex; gap: 12px; z-index: 101; }
        .btn { flex: 1; padding: 14px; border-radius: 12px; border: none; font-size: 17px; font-weight: 600; cursor: pointer; }
        .btn-main { background: var(--blue); color: white; }
        .btn-sec { background: #E5E5EA; color: var(--blue); }
        .text-btn { background: none; border: none; color: var(--blue); font-size: 17px; padding: 0; }
        .loader { text-align: center; padding: 20px; color: var(--gray); }
        
        .stat-header { cursor: pointer; }
        .stats-detail { display: none; background: #F9F9F9; padding: 10px 16px; font-size: 14px; color: #555; }
        .stats-detail.open { display: block; }
    </style>
</head>
<body>

    <div class="view-home">
        <header>
            <h1>Alpha</h1>
            <div style="position: relative;">
                <button class="date-btn" id="dateBtnLabel">...</button>
                <input type="date" id="datePicker" class="date-input-hidden" onchange="changeDate(this.value)">
            </div>
        </header>
        <div class="grid" id="tablesGrid"></div>
        <div style="padding: 20px;">
            <button onclick="openStats()" class="btn btn-sec" style="width: 100%;">История и Статистика</button>
        </div>
    </div>

    <div id="modal-table" class="modal-view">
        <header>
            <button onclick="closeModal('modal-table')" class="text-btn">Назад</button>
            <h2 id="tableTitle">Стол</h2>
            <div style="width:40px"></div>
        </header>
        <div class="list-wrap">
            <div class="ios-list" id="guestListContainer"></div>
            <div class="ios-list" style="margin-top: 20px;">
                 <button class="text-btn" style="width:100%; text-align:left; padding:16px;" onclick="addNewGuest()">+ Добавить участника</button>
            </div>
        </div>
        <div class="fab-bar">
            <button class="btn btn-main" onclick="saveAttendance()" id="saveBtn">Сохранить</button>
        </div>
    </div>

    <div id="modal-stats" class="modal-view">
        <header>
            <button onclick="closeModal('modal-stats')" class="text-btn">Закрыть</button>
            <h2>Статистика</h2>
            <div style="width:40px"></div>
        </header>
        <div class="list-wrap" id="statsContent"></div>
    </div>

    <script>
        // --- ⚙️ НАСТРОЙКИ (ВСТАВЬ СВОИ КЛЮЧИ НИЖЕ) ---
        const SUPABASE_URL = 'https://uwvrcnxztbnmmufevdbz.supabase.co'; // <-- ВСТАВЬ URL
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV3dnJjbnh6dGJubW11ZmV2ZGJ6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg1ODk4MjksImV4cCI6MjA4NDE2NTgyOX0.acH6VuKZZx47j8yCzNpBJwpQyWJUq7BKRKerFPeDGeI';                  // <-- ВСТАВЬ KEY
        // ------------------------------------------------

        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        let currentTable = null;
        let activeDate = new Date().toISOString().split('T')[0];

        // --- INIT ---
        function init() {
            updateDateLabel();
            loadGridStatuses();
        }

        function updateDateLabel() {
            const label = document.getElementById('dateBtnLabel');
            const parts = activeDate.split('-');
            const today = new Date().toISOString().split('T')[0];
            label.innerText = (activeDate === today) ? "Сегодня" : `${parts[2]}.${parts[1]}`;
            label.style.color = (activeDate === today) ? "var(--blue)" : "var(--red)";
        }

        function changeDate(val) {
            if(!val) return;
            activeDate = val;
            updateDateLabel();
            loadGridStatuses();
        }

        // --- HOME LOGIC ---
        async function loadGridStatuses() {
            const grid = document.getElementById('tablesGrid');
            grid.innerHTML = '<div class="loader" style="grid-column: 1/-1">Загрузка данных...</div>';

            // Получаем все записи посещаемости за эту дату, чтобы подсветить готовые столы
            const { data, error } = await supabase
                .from('attendance')
                .select('table_number')
                .eq('check_date', activeDate);

            const activeTables = new Set();
            if (data) data.forEach(r => activeTables.add(r.table_number));

            grid.innerHTML = '';
            for (let i = 1; i <= 12; i++) {
                const btn = document.createElement('button');
                const isDone = activeTables.has(i);
                btn.className = `table-card ${isDone ? 'done' : ''}`;
                btn.innerHTML = `<span class="t-num">${i}</span><span class="t-lbl">Стол</span>`;
                btn.onclick = () => openTable(i);
                grid.appendChild(btn);
            }
        }

        // --- TABLE LOGIC ---
        async function openTable(num) {
            currentTable = num;
            document.getElementById('tableTitle').innerText = `Стол №${num}`;
            document.getElementById('modal-table').classList.add('active');
            renderGuestList();
        }

        async function renderGuestList() {
            const container = document.getElementById('guestListContainer');
            container.innerHTML = '<div class="loader">Загружаем список...</div>';

            // 1. Загружаем гостей стола
            const { data: guests } = await supabase
                .from('guests')
                .select('*')
                .eq('table_number', currentTable)
                .order('full_name');

            // 2. Загружаем статусы за дату
            const { data: attendance } = await supabase
                .from('attendance')
                .select('*')
                .eq('check_date', activeDate)
                .eq('table_number', currentTable);

            container.innerHTML = '';
            if (!guests || guests.length === 0) {
                container.innerHTML = '<div style="padding:20px; text-align:center; color:#999">Список пуст</div>';
                return;
            }

            guests.forEach(guest => {
                // Если записи нет, по дефолту TRUE (Пришел)
                const record = attendance.find(r => r.guest_id === guest.id);
                const isChecked = record ? record.is_present : true;

                const div = document.createElement('div');
                div.className = 'guest-row';
                div.innerHTML = `
                    <span class="g-name">${guest.full_name}</span>
                    <label class="switch">
                        <input type="checkbox" ${isChecked ? 'checked' : ''} data-id="${guest.id}">
                        <span class="slider"></span>
                    </label>
                `;
                container.appendChild(div);
            });
        }

        async function addNewGuest() {
            const name = prompt("Имя и Фамилия:");
            if (!name) return;

            const { error } = await supabase
                .from('guests')
                .insert([{ full_name: name, table_number: currentTable }]);

            if (error) alert("Ошибка добавления");
            else renderGuestList(); // Обновляем список
        }

        async function saveAttendance() {
            const btn = document.getElementById('saveBtn');
            btn.innerText = "Сохраняем...";

            const inputs = document.querySelectorAll('#guestListContainer input[type="checkbox"]');
            const updates = [];

            // Подготовка данных для отправки
            inputs.forEach(input => {
                updates.push({
                    guest_id: input.getAttribute('data-id'),
                    check_date: activeDate,
                    is_present: input.checked,
                    table_number: currentTable
                });
            });

            // Массовая вставка/обновление (Upsert)
            // Важно: в базе должен быть unique constraint (мы его не делали жестким в SQL выше для простоты, 
            // но Supabase обработает это. Для идеала лучше удалить старое за дату).
            
            // Простой вариант: Удалить старое -> Вставить новое (чтобы не дублировать)
            await supabase.from('attendance').delete().eq('check_date', activeDate).eq('table_number', currentTable);
            const { error } = await supabase.from('attendance').insert(updates);

            if (error) {
                alert("Ошибка сохранения");
                btn.innerText = "Сохранить";
            } else {
                btn.innerText = "Сохранено!";
                btn.style.background = "var(--green)";
                setTimeout(() => {
                    closeModal('modal-table');
                    setTimeout(() => { 
                        btn.innerText = "Сохранить"; 
                        btn.style.background = ""; 
                    }, 400);
                }, 500);
            }
        }

        // --- STATS LOGIC ---
        async function openStats() {
            document.getElementById('modal-stats').classList.add('active');
            const container = document.getElementById('statsContent');
            container.innerHTML = '<div class="loader">Считаем статистику...</div>';

            // Получаем ВСЮ историю посещений (только где были)
            const { data: log } = await supabase
                .from('attendance')
                .select('*')
                .eq('is_present', true);

            if (!log || log.length === 0) {
                container.innerHTML = '<div style="padding:20px; text-align:center">Нет данных</div>';
                return;
            }

            // Группируем по датам
            const dates = [...new Set(log.map(i => i.check_date))].sort().reverse();
            
            container.innerHTML = '<div class="ios-list">';
            dates.forEach((date, idx) => {
                const dayLog = log.filter(r => r.check_date === date);
                const total = dayLog.length;
                
                // Детали по столам
                const byTable = {};
                dayLog.forEach(r => { byTable[r.table_number] = (byTable[r.table_number] || 0) + 1; });

                let detailsHTML = '';
                for(let t=1; t<=12; t++) {
                    if(byTable[t]) detailsHTML += `<div style="display:flex; justify-content:space-between; margin-bottom:5px;"><span>Стол ${t}</span><b>${byTable[t]}</b></div>`;
                }

                const dParts = date.split('-');
                const div = document.createElement('div');
                div.innerHTML = `
                    <div class="guest-row stat-header" onclick="document.getElementById('d-${idx}').classList.toggle('open')">
                        <span style="font-weight:500">${dParts[2]}.${dParts[1]}.${dParts[0]}</span>
                        <span style="background:#E5E5EA; padding:4px 8px; border-radius:6px; font-weight:bold">${total}</span>
                    </div>
                    <div id="d-${idx}" class="stats-detail">${detailsHTML}</div>
                `;
                container.querySelector('.ios-list').appendChild(div);
            });
        }

        function closeModal(id) {
            document.getElementById(id).classList.remove('active');
            if(id === 'modal-table') loadGridStatuses(); // Обновить галочки на главной
        }

        init();
    </script>
</body>
</html>