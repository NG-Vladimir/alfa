<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Alpha Cloud</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        /* --- SYSTEM DESIGN (iOS Clean) --- */
        :root { --bg: #F2F2F7; --card: #FFFFFF; --blue: #007AFF; --green: #34C759; --red: #FF3B30; --gray: #8E8E93; --separator: #C6C6C8; }
        body { font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif; background-color: var(--bg); margin: 0; padding: 0; color: #000; -webkit-tap-highlight-color: transparent; overflow-x: hidden; }

        /* Views */
        .view-home { min-height: 100vh; padding-bottom: 40px; }
        .modal-view { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: var(--bg); z-index: 100; transform: translateY(100%); transition: transform 0.35s cubic-bezier(0.165, 0.84, 0.44, 1); display: flex; flex-direction: column; }
        .modal-view.active { transform: translateY(0); }

        /* Header */
        header { padding: 14px 20px; background: rgba(242, 242, 247, 0.95); backdrop-filter: blur(10px); position: sticky; top: 0; z-index: 50; border-bottom: 0.5px solid rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; height: 44px; }
        h1 { font-size: 28px; font-weight: 800; margin: 0; letter-spacing: -0.5px; }
        h2 { font-size: 17px; font-weight: 600; margin: 0; }

        /* Date Button */
        .date-btn-wrapper { position: relative; }
        .date-btn { background: rgba(118, 118, 128, 0.12); color: var(--blue); font-weight: 500; padding: 6px 12px; border-radius: 8px; font-size: 15px; border: none; }
        .date-input-hidden { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; }

        /* Grid */
        .grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; padding: 20px; }
        .table-card { background: var(--card); border-radius: 16px; height: 90px; display: flex; flex-direction: column; justify-content: center; align-items: center; border: none; box-shadow: 0 2px 8px rgba(0,0,0,0.03); position: relative; transition: all 0.1s; }
        .table-card:active { transform: scale(0.95); background: #E5E5EA; }
        .table-card.done { border: 2px solid var(--green); }
        .table-card.done .t-num { color: var(--green); }
        .t-num { font-size: 26px; font-weight: 700; color: var(--blue); }
        .t-lbl { font-size: 12px; color: var(--gray); margin-top: 2px; font-weight: 500; }

        /* List & Controls */
        .list-wrap { padding: 20px; flex: 1; overflow-y: auto; padding-bottom: 120px; }
        .ios-list { background: var(--card); border-radius: 12px; overflow: hidden; }
        .guest-row { display: flex; justify-content: space-between; align-items: center; padding: 14px 16px; border-bottom: 0.5px solid var(--separator); min-height: 24px; }
        .guest-row:last-child { border-bottom: none; }
        .g-name { font-size: 17px; font-weight: 400; color: #000; }
        .del-btn, .rename-btn { color: var(--blue); font-size: 15px; background: none; border: none; padding: 0 10px; }
        
        /* Switch */
        .switch { position: relative; display: inline-block; width: 51px; height: 31px; flex-shrink: 0;}
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #E9E9EA; transition: .3s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 27px; width: 27px; left: 2px; bottom: 2px; background-color: white; transition: .3s; border-radius: 50%; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        input:checked + .slider { background-color: var(--green); }
        input:checked + .slider:before { transform: translateX(20px); }

        /* Fab Bar */
        .fab-bar { position: fixed; bottom: 0; left: 0; right: 0; background: rgba(255,255,255,0.9); backdrop-filter: blur(20px); padding: 12px 20px 30px 20px; border-top: 0.5px solid rgba(0,0,0,0.1); display: flex; gap: 12px; z-index: 101; }
        .btn { flex: 1; padding: 14px; border-radius: 12px; border: none; font-size: 17px; font-weight: 600; cursor: pointer; }
        .btn-main { background: var(--blue); color: white; }
        .btn-sec { background: #E5E5EA; color: var(--blue); }
        .text-btn { background: none; border: none; color: var(--blue); font-size: 17px; padding: 0; cursor: pointer;}
        .add-guest-btn { width: 100%; text-align: left; padding: 16px; background: none; border: none; color: var(--blue); font-size: 17px; border-bottom: 0.5px solid var(--separator); }

        /* Stats */
        .stats-detail { display: none; background: #F8F8F8; padding: 10px 16px; font-size: 14px; color: #555; line-height: 1.8; border-bottom: 0.5px solid var(--separator); }
        .stats-detail.open { display: block; }
        .stat-header { cursor: pointer; font-weight: 500; }
        .count-badge { background: #E5E5EA; color: #000; padding: 4px 8px; border-radius: 6px; font-size: 14px; font-weight: 600; }
        
        .loader { text-align: center; color: var(--gray); padding: 20px; font-size: 14px; }
        .error-msg { color: var(--red); padding: 20px; text-align: center; background: #FFF0F0; border-radius: 12px; margin: 20px; border: 1px solid #FFCDCD; }
    </style>
</head>
<body>

    <div class="view-home">
        <header>
            <h1>Alpha</h1>
            <div class="date-btn-wrapper">
                <button class="date-btn" id="dateBtnLabel">Сегодня</button>
                <input type="date" id="datePicker" class="date-input-hidden" onchange="changeDate(this.value)">
            </div>
        </header>

        <div class="grid" id="tablesGrid">
            <div class="loader">Подключение к базе данных...</div>
        </div>

        <div style="padding: 20px;">
            <button onclick="openStats()" class="btn btn-sec" style="width: 100%;">История и Статистика</button>
        </div>
    </div>

    <div id="modal-table" class="modal-view">
        <header>
            <button onclick="closeModal('modal-table')" class="text-btn">Назад</button>
            <h2 id="tableTitle">Стол</h2>
            <div style="width:40px"></div>
        </header>

        <div class="list-wrap">
            <div class="ios-list" id="guestListContainer"></div>
            <div class="ios-list" style="margin-top: 20px;">
                 <button class="add-guest-btn" onclick="addNewGuest()">+ Добавить участника</button>
            </div>
        </div>

        <div class="fab-bar">
            <button class="btn btn-main" onclick="saveAttendance()" id="saveBtn">Сохранить</button>
        </div>
    </div>

    <div id="modal-stats" class="modal-view">
        <header>
            <button onclick="closeModal('modal-stats')" class="text-btn">Закрыть</button>
            <h2>Статистика</h2>
            <div style="width: 40px"></div>
        </header>

        <div class="list-wrap" id="statsContent"></div>
    </div>

    <script>
        // ==========================================
        //  КЛЮЧИ ПОДКЛЮЧЕНИЯ (УЖЕ ВСТАВЛЕНЫ)
        // ==========================================
        
        const SUPABASE_URL = 'https://uwvrcnxztbnmmufevdbz.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV3dnJjbnh6dGJubW11ZmV2ZGJ6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg1ODk4MjksImV4cCI6MjA4NDE2NTgyOX0.acH6VuKZZx47j8yCzNpBJwpQyWJUq7BKRKerFPeDGeI';

        // ==========================================

        // Создаем клиента ОДИН РАЗ
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        let currentTable = null;
        let activeDate = new Date().toISOString().split('T')[0];

        // --- INIT ---
        function init() {
            updateDateLabel();
            loadGridStatuses();
        }

        function updateDateLabel() {
            const label = document.getElementById('dateBtnLabel');
            const today = new Date().toISOString().split('T')[0];
            const parts = activeDate.split('-');
            const formatted = `${parts[2]}.${parts[1]}`;
            
            if (activeDate === today) {
                label.innerText = "Сегодня";
                label.style.color = "var(--blue)";
            } else {
                label.innerText = formatted;
                label.style.color = "var(--red)";
            }
        }

        function changeDate(val) {
            if(!val) return;
            activeDate = val;
            updateDateLabel();
            loadGridStatuses();
        }

        // --- HOME RENDER ---
        async function loadGridStatuses() {
            const grid = document.getElementById('tablesGrid');
            grid.innerHTML = '<div class="loader">Загрузка данных...</div>';

            // Запрашиваем данные
            const { data, error } = await supabase
                .from('attendance')
                .select('table_number')
                .eq('check_date', activeDate);

            if (error) {
                console.error(error);
                grid.innerHTML = `<div class="error-msg"><b>Ошибка доступа к базе!</b><br>Защита (RLS) всё еще включена.<br>Зайди в Supabase -> Table Editor -> Выключи RLS для обеих таблиц.</div>`;
                return;
            }

            const activeTables = new Set();
            if (data) data.forEach(r => activeTables.add(r.table_number));

            grid.innerHTML = '';
            for (let i = 1; i <= 12; i++) {
                const btn = document.createElement('button');
                const isDone = activeTables.has(i);
                btn.className = `table-card ${isDone ? 'done' : ''}`;
                btn.innerHTML = `<span class="t-num">${i}</span><span class="t-lbl">Стол</span>`;
                btn.onclick = () => openTable(i);
                grid.appendChild(btn);
            }
        }

        // --- NAVIGATION ---
        async function openTable(num) {
            currentTable = num;
            document.getElementById('tableTitle').innerText = `Стол №${num}`;
            document.getElementById('modal-table').classList.add('active');
            renderGuestList();
        }

        async function openStats() {
            document.getElementById('modal-stats').classList.add('active');
            renderStats();
        }

        function closeModal(id) {
            document.getElementById(id).classList.remove('active');
            if(id === 'modal-table') loadGridStatuses();
        }

        // --- TABLE LOGIC ---
        async function renderGuestList() {
            const container = document.getElementById('guestListContainer');
            container.innerHTML = '<div class="loader">Загрузка...</div>';

            // 1. Гости стола
            const { data: guests, error: err1 } = await supabase
                .from('guests')
                .select('*')
                .eq('table_number', currentTable)
                .order('full_name');

            // 2. Статусы за дату
            const { data: attendance, error: err2 } = await supabase
                .from('attendance')
                .select('*')
                .eq('check_date', activeDate)
                .eq('table_number', currentTable);

            if (err1 || err2) {
                container.innerHTML = '<div class="error-msg">Ошибка загрузки списка</div>';
                return;
            }

            container.innerHTML = '';
            if (!guests || guests.length === 0) {
                container.innerHTML = '<div style="padding:30px; text-align:center; color:#999">Список пуст</div>';
                return;
            }

            guests.forEach(guest => {
                const record = attendance.find(r => r.guest_id === guest.id);
                const isChecked = record ? record.is_present : true;

                const div = document.createElement('div');
                div.className = 'guest-row';
                div.innerHTML = `
                    <span class="g-name">${guest.full_name}</span>
                    <label class="switch">
                        <input type="checkbox" ${isChecked ? 'checked' : ''} data-id="${guest.id}">
                        <span class="slider"></span>
                    </label>
                `;
                container.appendChild(div);
            });
        }

        async function addNewGuest() {
            const name = prompt("Имя и Фамилия:");
            if (!name) return;

            const { error } = await supabase
                .from('guests')
                .insert([{ full_name: name, table_number: currentTable }]);

            if (error) alert("Ошибка добавления: " + error.message);
            else renderGuestList();
        }

        async function saveAttendance() {
            const btn = document.getElementById('saveBtn');
            const originalText = btn.innerText;
            btn.innerText = "Сохраняем...";

            const inputs = document.querySelectorAll('#guestListContainer input[type="checkbox"]');
            const updates = [];

            inputs.forEach(input => {
                updates.push({
                    guest_id: input.getAttribute('data-id'),
                    check_date: activeDate,
                    is_present: input.checked,
                    table_number: currentTable
                });
            });

            // Удаляем старые, пишем новые (чтобы не было дублей)
            await supabase.from('attendance').delete()
                .eq('check_date', activeDate)
                .eq('table_number', currentTable);
                
            const { error } = await supabase.from('attendance').insert(updates);

            if (error) {
                alert("Ошибка сохранения: " + error.message);
                btn.innerText = originalText;
            } else {
                btn.innerText = "Готово!";
                btn.style.background = "var(--green)";
                setTimeout(() => {
                    closeModal('modal-table');
                    setTimeout(() => { btn.innerText = "Сохранить"; btn.style.background = ""; }, 400);
                }, 500);
            }
        }

        // --- STATS LOGIC ---
        async function renderStats() {
            const container = document.getElementById('statsContent');
            container.innerHTML = '<div class="loader">Считаем...</div>';

            const { data: log, error } = await supabase
                .from('attendance')
                .select('*')
                .eq('is_present', true);

            if (error) {
                container.innerHTML = '<div class="error-msg">Ошибка загрузки статистики</div>';
                return;
            }

            if (!log || log.length === 0) {
                container.innerHTML = '<div style="padding:40px; text-align:center; color:#999">Истории пока нет</div>';
                return;
            }

            const dates = [...new Set(log.map(i => i.check_date))].sort().reverse();
            
            container.innerHTML = '<div class="ios-list">';
            dates.forEach((date, index) => {
                const dayLog = log.filter(r => r.check_date === date);
                const total = dayLog.length;

                const byTable = {};
                dayLog.forEach(r => { byTable[r.table_number] = (byTable[r.table_number] || 0) + 1; });

                let detailsHTML = '';
                for(let t=1; t<=12; t++) {
                    if(byTable[t]) {
                        detailsHTML += `<div style="display:flex; justify-content:space-between; margin-bottom:4px;">
                            <span>Стол ${t}</span><span style="font-weight:600">${byTable[t]} чел.</span></div>`;
                    }
                }
                if(detailsHTML === '') detailsHTML = 'Никого не было';

                const dParts = date.split('-');
                const displayDate = `${dParts[2]}.${dParts[1]}.${dParts[0]}`;
                const detailId = `detail-${index}`;

                const div = document.createElement('div');
                div.innerHTML = `
                    <div class="guest-row stat-header" onclick="document.getElementById('${detailId}').classList.toggle('open')">
                        <span style="font-size:17px;">${displayDate}</span>
                        <span class="count-badge">${total}</span>
                    </div>
                    <div id="${detailId}" class="stats-detail">${detailsHTML}</div>
                `;
                container.querySelector('.ios-list').appendChild(div);
            });
            container.innerHTML += '</div>';
        }

        init();
    </script>
</body>
</html>