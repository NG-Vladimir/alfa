<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Alpha App</title>
    
    <style>
        /* --- SYSTEM DESIGN (iOS Clean) --- */
        :root {
            --bg: #F2F2F7;
            --card: #FFFFFF;
            --blue: #007AFF;
            --green: #34C759;
            --red: #FF3B30;
            --gray: #8E8E93;
            --separator: #C6C6C8;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif;
            background-color: var(--bg);
            margin: 0; padding: 0;
            color: #000;
            -webkit-tap-highlight-color: transparent;
            overflow-x: hidden; /* Чтобы анимация не ломала скролл */
        }

        /* --- ANIMATIONS (SLIDE UP) --- */
        /* Базовый экран (Home) всегда на месте */
        .view-home {
            min-height: 100vh;
            padding-bottom: 40px;
        }

        /* Модальные экраны (скрыты внизу) */
        .modal-view {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: var(--bg);
            z-index: 100;
            transform: translateY(100%); /* Сдвинут вниз */
            transition: transform 0.35s cubic-bezier(0.165, 0.84, 0.44, 1); /* iOS Easing */
            display: flex; flex-direction: column;
        }

        .modal-view.active {
            transform: translateY(0); /* Выезжает вверх */
        }

        /* HEADER */
        header {
            padding: 14px 20px;
            background: rgba(242, 242, 247, 0.95);
            backdrop-filter: blur(10px);
            position: sticky; top: 0; z-index: 50;
            border-bottom: 0.5px solid rgba(0,0,0,0.1);
            display: flex; justify-content: space-between; align-items: center;
            height: 44px;
        }
        h1 { font-size: 28px; font-weight: 800; margin: 0; letter-spacing: -0.5px; }
        h2 { font-size: 17px; font-weight: 600; margin: 0; }

        /* DATE BUTTON */
        .date-btn-wrapper { position: relative; }
        .date-btn {
            background: rgba(118, 118, 128, 0.12);
            color: var(--blue);
            font-weight: 500;
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 15px;
            border: none;
        }
        .date-input-hidden {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            opacity: 0; cursor: pointer;
        }

        /* GRID SYSTEM */
        .grid { 
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; 
            padding: 20px;
        }
        .table-card {
            background: var(--card); border-radius: 16px; height: 90px;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            border: none; box-shadow: 0 2px 8px rgba(0,0,0,0.03);
            position: relative; transition: all 0.1s;
        }
        .table-card:active { transform: scale(0.95); background: #E5E5EA; }
        
        /* Статус готовности (без эмодзи, просто цвет цифры и рамка) */
        .table-card.done { border: 1.5px solid var(--green); }
        .table-card.done .t-num { color: var(--green); }
        
        .t-num { font-size: 26px; font-weight: 700; color: var(--blue); }
        .t-lbl { font-size: 12px; color: var(--gray); margin-top: 2px; font-weight: 500; }

        /* LISTS */
        .list-wrap { padding: 20px; flex: 1; overflow-y: auto; padding-bottom: 120px; }
        .ios-list { background: var(--card); border-radius: 12px; overflow: hidden; }
        .guest-row {
            display: flex; justify-content: space-between; align-items: center;
            padding: 14px 16px; border-bottom: 0.5px solid var(--separator);
            min-height: 24px;
        }
        .guest-row:last-child { border-bottom: none; }
        .g-name { font-size: 17px; font-weight: 400; color: #000; }

        /* EDIT CONTROLS */
        .del-btn { color: var(--red); font-size: 15px; background: none; border: none; padding: 0 10px; }
        .rename-btn { color: var(--blue); font-size: 15px; background: none; border: none; padding: 0 10px; }

        /* TOGGLE SWITCH (Green) */
        .switch { position: relative; display: inline-block; width: 51px; height: 31px; flex-shrink: 0;}
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
            background-color: #E9E9EA; transition: .3s; border-radius: 34px;
        }
        .slider:before {
            position: absolute; content: ""; height: 27px; width: 27px; left: 2px; bottom: 2px;
            background-color: white; transition: .3s; border-radius: 50%; box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        input:checked + .slider { background-color: var(--green); }
        input:checked + .slider:before { transform: translateX(20px); }

        /* BOTTOM BAR */
        .fab-bar {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: rgba(255,255,255,0.9); backdrop-filter: blur(20px);
            padding: 12px 20px 30px 20px;
            border-top: 0.5px solid rgba(0,0,0,0.1);
            display: flex; gap: 12px; z-index: 101;
        }
        .btn {
            flex: 1; padding: 14px; border-radius: 12px; border: none;
            font-size: 17px; font-weight: 600; cursor: pointer;
        }
        .btn-main { background: var(--blue); color: white; }
        .btn-sec { background: #E5E5EA; color: var(--blue); }
        .text-btn { background: none; border: none; color: var(--blue); font-size: 17px; padding: 0; cursor: pointer;}
        
        /* ADD GUEST BUTTON */
        .add-guest-btn {
            width: 100%; text-align: left; padding: 16px; 
            background: none; border: none; 
            color: var(--blue); font-size: 17px;
            border-bottom: 0.5px solid var(--separator);
        }

        /* STATS EXPANSION */
        .stats-detail {
            display: none;
            background: #F8F8F8;
            padding: 10px 16px;
            font-size: 14px;
            color: #555;
            line-height: 1.8;
            border-bottom: 0.5px solid var(--separator);
        }
        .stats-detail.open { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .stat-header { cursor: pointer; font-weight: 500; }
        .count-badge { 
            background: #E5E5EA; color: #000; 
            padding: 4px 8px; border-radius: 6px; 
            font-size: 14px; font-weight: 600; 
        }

    </style>
</head>
<body>

    <div class="view-home">
        <header>
            <h1>Alpha</h1>
            <div class="date-btn-wrapper">
                <button class="date-btn" id="dateBtnLabel">Сегодня</button>
                <input type="date" id="datePicker" class="date-input-hidden" onchange="changeDate(this.value)">
            </div>
        </header>

        <div class="grid" id="tablesGrid"></div>

        <div style="padding: 20px;">
            <button onclick="openStats()" class="btn btn-sec" style="width: 100%;">История и Статистика</button>
        </div>
    </div>

    <div id="modal-table" class="modal-view">
        <header>
            <button onclick="closeModal('modal-table')" class="text-btn">Назад</button>
            <h2 id="tableTitle">Стол</h2>
            <button onclick="toggleEditMode()" class="text-btn" id="editBtn">Изм.</button>
        </header>

        <div class="list-wrap">
            <div class="ios-list" id="guestListContainer"></div>
            <div class="ios-list" style="margin-top: 20px;">
                 <button class="add-guest-btn" onclick="addNewGuest()">Добавить участника...</button>
            </div>
        </div>

        <div class="fab-bar">
            <button class="btn btn-main" onclick="saveAttendance()" id="saveBtn">Сохранить</button>
        </div>
    </div>

    <div id="modal-stats" class="modal-view">
        <header>
            <button onclick="closeModal('modal-stats')" class="text-btn">Закрыть</button>
            <h2>Статистика</h2>
            <div style="width: 40px"></div>
        </header>

        <div class="list-wrap" id="statsContent"></div>
        
        <div style="text-align: center; padding-bottom: 40px;">
            <button onclick="resetAllData()" style="color: var(--red); background: none; border: none; font-size: 14px;">Сброс данных</button>
        </div>
    </div>

    <script>
        // --- DATA ---
        let currentTable = null;
        let activeDate = new Date().toISOString().split('T')[0];
        let isEditMode = false;

        function getGuests() { return JSON.parse(localStorage.getItem('alpha_guests') || '[]'); }
        function setGuests(data) { localStorage.setItem('alpha_guests', JSON.stringify(data)); }
        function getAttendance() { return JSON.parse(localStorage.getItem('alpha_attendance') || '[]'); }
        
        // --- INIT ---
        function init() {
            updateDateLabel();
            renderGrid();
        }

        function updateDateLabel() {
            const label = document.getElementById('dateBtnLabel');
            const today = new Date().toISOString().split('T')[0];
            const parts = activeDate.split('-');
            // Формат даты: ДД.ММ
            const formatted = `${parts[2]}.${parts[1]}`;
            
            if (activeDate === today) {
                label.innerText = "Сегодня";
                label.style.color = "var(--blue)";
            } else {
                label.innerText = formatted;
                label.style.color = "var(--red)";
            }
        }

        function changeDate(val) {
            if(!val) return;
            activeDate = val;
            updateDateLabel();
            renderGrid(); 
        }

        // --- HOME RENDER ---
        function renderGrid() {
            const grid = document.getElementById('tablesGrid');
            grid.innerHTML = '';
            
            const log = getAttendance();
            const activeTables = new Set(
                log.filter(r => r.date === activeDate).map(r => r.tableId)
            );

            for (let i = 1; i <= 12; i++) {
                const btn = document.createElement('button');
                const isDone = activeTables.has(i);
                // Класс done меняет цвет рамки
                btn.className = `table-card ${isDone ? 'done' : ''}`;
                btn.innerHTML = `<span class="t-num">${i}</span><span class="t-lbl">Стол</span>`;
                btn.onclick = () => openTable(i);
                grid.appendChild(btn);
            }
        }

        // --- NAVIGATION (MODALS) ---
        function openTable(num) {
            currentTable = num;
            isEditMode = false;
            document.getElementById('editBtn').innerText = "Изм.";
            document.getElementById('tableTitle').innerText = `Стол №${num}`;
            renderGuestList();
            // Анимация выезда
            document.getElementById('modal-table').classList.add('active');
        }

        function openStats() {
            renderStats();
            document.getElementById('modal-stats').classList.add('active');
        }

        function closeModal(id) {
            document.getElementById(id).classList.remove('active');
            setTimeout(() => {
                if(id === 'modal-table') renderGrid(); // Обновить главную
            }, 350); // Ждем конца анимации
        }

        // --- TABLE LOGIC ---
        function toggleEditMode() {
            isEditMode = !isEditMode;
            document.getElementById('editBtn').innerText = isEditMode ? "Готово" : "Изм.";
            renderGuestList();
        }

        function renderGuestList() {
            const container = document.getElementById('guestListContainer');
            let guests = getGuests().filter(g => g.tableId === currentTable);
            guests.sort((a, b) => a.name.localeCompare(b.name));

            const log = getAttendance();
            container.innerHTML = '';

            if (guests.length === 0) {
                // Пустой список, ничего не рисуем (кнопка добавить внизу)
            }

            guests.forEach(guest => {
                const record = log.find(r => r.guestId === guest.id && r.date === activeDate);
                const isChecked = record ? record.isPresent : true;

                const div = document.createElement('div');
                div.className = 'guest-row';

                if (isEditMode) {
                    div.innerHTML = `
                        <input type="text" value="${guest.name}" id="edit-name-${guest.id}" 
                            style="border:none; background:#F2F2F7; padding:8px; border-radius:6px; font-size:16px; width:55%">
                        <div style="display:flex;">
                            <button class="rename-btn" onclick="renameGuest(${guest.id})">ОК</button>
                            <button class="del-btn" onclick="deleteGuest(${guest.id})">Удалить</button>
                        </div>
                    `;
                } else {
                    div.innerHTML = `
                        <span class="g-name">${guest.name}</span>
                        <label class="switch">
                            <input type="checkbox" ${isChecked ? 'checked' : ''} data-id="${guest.id}">
                            <span class="slider"></span>
                        </label>
                    `;
                }
                container.appendChild(div);
            });
        }

        function addNewGuest() {
            const name = prompt("Имя и Фамилия:");
            if (!name) return;
            const all = getGuests();
            all.push({ id: Date.now(), name: name, tableId: currentTable });
            setGuests(all);
            renderGuestList();
        }

        function deleteGuest(id) {
            if(!confirm("Удалить?")) return;
            let all = getGuests();
            all = all.filter(g => g.id !== id);
            setGuests(all);
            renderGuestList();
        }

        function renameGuest(id) {
            const newName = document.getElementById(`edit-name-${id}`).value;
            let all = getGuests();
            const idx = all.findIndex(g => g.id === id);
            if(idx !== -1) {
                all[idx].name = newName;
                setGuests(all);
                // Мигание для подтверждения
                const btn = document.activeElement;
                btn.innerText = "✓";
                setTimeout(() => btn.innerText = "ОК", 1000);
            }
        }

        function saveAttendance() {
            if(isEditMode) { alert("Завершите редактирование"); return; }
            
            const inputs = document.querySelectorAll('#guestListContainer input[type="checkbox"]');
            let log = getAttendance();

            // Удаляем старые записи за этот день/стол
            log = log.filter(r => !(r.date === activeDate && r.tableId === currentTable));

            inputs.forEach(input => {
                log.push({
                    date: activeDate,
                    guestId: parseInt(input.getAttribute('data-id')),
                    isPresent: input.checked,
                    tableId: currentTable
                });
            });

            localStorage.setItem('alpha_attendance', JSON.stringify(log));
            
            // UI Feedback (Кнопка становится зеленой)
            const btn = document.getElementById('saveBtn');
            const oldText = btn.innerText;
            btn.innerText = "Сохранено";
            btn.style.background = "var(--green)";
            
            setTimeout(() => {
                closeModal('modal-table');
                setTimeout(() => {
                    btn.innerText = oldText;
                    btn.style.background = "";
                }, 400);
            }, 500);
        }

        // --- STATS LOGIC (UPDATED) ---
        function renderStats() {
            const container = document.getElementById('statsContent');
            const log = getAttendance();
            const uniqueDates = [...new Set(log.map(i => i.date))].sort().reverse();

            if (uniqueDates.length === 0) {
                container.innerHTML = '<div style="padding:40px; text-align:center; color:#999">Истории пока нет</div>';
                return;
            }

            container.innerHTML = '<div class="ios-list">';
            
            uniqueDates.forEach((date, index) => {
                // Общий подсчет
                const presentRecords = log.filter(r => r.date === date && r.isPresent);
                const totalCount = presentRecords.length;

                // Подсчет по столам
                const byTable = {};
                presentRecords.forEach(r => {
                    byTable[r.tableId] = (byTable[r.tableId] || 0) + 1;
                });

                // Генерация HTML для деталей
                let detailsHTML = '';
                for(let t=1; t<=12; t++) {
                    if(byTable[t]) {
                        detailsHTML += `<div style="display:flex; justify-content:space-between; margin-bottom:4px;">
                            <span>Стол ${t}</span>
                            <span style="font-weight:600">${byTable[t]} чел.</span>
                        </div>`;
                    }
                }
                if(detailsHTML === '') detailsHTML = 'Никого не было';

                // Формат даты
                const dParts = date.split('-');
                const displayDate = `${dParts[2]}.${dParts[1]}.${dParts[0]}`;

                // Уникальный ID для спойлера
                const detailId = `detail-${index}`;

                const div = document.createElement('div');
                div.innerHTML = `
                    <div class="guest-row stat-header" onclick="toggleDetail('${detailId}')">
                        <span style="font-size:17px;">${displayDate}</span>
                        <span class="count-badge">${totalCount}</span>
                    </div>
                    <div id="${detailId}" class="stats-detail">
                        ${detailsHTML}
                    </div>
                `;
                container.querySelector('.ios-list').appendChild(div);
            });
            container.innerHTML += '</div>';
        }

        function toggleDetail(id) {
            const el = document.getElementById(id);
            if (el.classList.contains('open')) {
                el.classList.remove('open');
            } else {
                el.classList.add('open');
            }
        }

        function resetAllData() {
            if(confirm("Удалить все данные? Это действие нельзя отменить.")) {
                localStorage.clear();
                location.reload();
            }
        }

        init();
    </script>
</body>
</html>